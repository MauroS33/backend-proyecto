<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <h1>Lista de Productos</h1>

  <!-- Contenedor de Productos -->
  <div id="product-list">
    {{#each products}}
      <div>
        <h3>{{this.title}}</h3>
        <p>Precio: ${{this.price}}</p>
        <button onclick="addToCart('{{this._id}}')">Agregar al Carrito</button>
      </div>
    {{/each}}
  </div>

  <!-- Paginación -->
  <div id="pagination">
    <button id="prev-page" {{#ifCond currentPage 1}}disabled{{/ifCond}}>Anterior</button>
    <span>Página {{currentPage}} de {{totalPages}}</span>
    <button id="next-page" {{#ifCond currentPage totalPages}}disabled{{/ifCond}}>Siguiente</button>
  </div>

  <!-- Carrito -->
  <h2>Mi Carrito</h2>
  <div id="cart">
    <p>Cargando carrito...</p>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let currentPage = {{currentPage}};
    const limit = 10;

    // Función para cargar productos paginados
    async function loadProducts(page) {
      window.location.href = `/products?page=${page}&limit=${limit}`;
    }

    // Función para agregar un producto al carrito
    async function addToCart(productId) {
      const cartId = localStorage.getItem('cartId'); // Obtener ID del carrito almacenado
      const quantity = 1;

      try {
        const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });

        if (!response.ok) throw new Error("Error al agregar producto al carrito");

        const cart = await response.json();
        loadCart(cartId); // Recargar el carrito
        alert("Producto agregado al carrito exitosamente");
      } catch (error) {
        console.error(error.message);
        alert("Ocurrió un error al agregar el producto");
      }
    }

    // Función para cargar el carrito
    async function loadCart(cartId) {
      try {
        const response = await fetch(`/api/carts/${cartId}`);
        if (!response.ok) throw new Error("Error al cargar el carrito");

        const cart = await response.json();
        const cartDiv = document.getElementById('cart');
        cartDiv.innerHTML = ''; // Limpiar el carrito

        if (cart.products.length === 0) {
          cartDiv.innerHTML = '<p>El carrito está vacío.</p>';
        } else {
          cart.products.forEach(item => {
            const productDiv = document.createElement('div');
            productDiv.innerHTML = `
              <p>${item.product.title} - Cantidad: ${item.quantity} - Subtotal: $${item.product.price * item.quantity}</p>
            `;
            cartDiv.appendChild(productDiv);
          });
        }
      } catch (error) {
        console.error(error.message);
        cartDiv.innerHTML = '<p>Error al cargar el carrito.</p>';
      }
    }

    // Inicializar el carrito
    document.addEventListener('DOMContentLoaded', async () => {
      let cartId = localStorage.getItem('cartId');
      if (!cartId) {
        const response = await fetch('/api/carts/', { method: 'POST' });
        const cart = await response.json();
        cartId = cart._id;
        localStorage.setItem('cartId', cartId); // Guardar ID del carrito
      }

      loadCart(cartId); // Cargar el carrito
    });
  </script>
</body>
</html>